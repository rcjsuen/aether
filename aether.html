<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
	<title>Aether</title>
	<meta charset="UTF-8">
	<style type="text/css">
		body {
			background-color: #000000;
			margin: 0;
		}
	</style>
	<script src="js/phaser.min.js"></script>
	<script src="js/SaveCPU.js"></script>
</head>
<body>

<script type="text/javascript">

var uppercaseKeys = [
	'A',
	'B',
	'C',
	'D',
	'E',
	'F',
	'G',
	'H',
	'I',
	'J',
	'K',
	'L',
	'M',
	'N',
	'O',
	'P',
	'Q',
	'R',
	'S',
	'T',
	'U',
	'V',
	'W',
	'X',
	'Y',
	'Z',
];

var english = [ "apple", "cat", "car", "dog", "pen", "eraser" ];
var japanese = [ "りんご", "猫", "車", "犬", "ペン", "消しゴム" ];
var done = [];

var game = new Phaser.Game(
	360, 640,
	Phaser.CANVAS, '', { preload: preload, create: create, update: update, render: render });
	
function preload() {
	window.addEventListener("keydown", function (event) {
		if (event.keyCode == 8) {
			event.preventDefault();
			if (scoreText.text.length > 0) {
				scoreText.text = scoreText.text.substring(0, scoreText.text.length - 1);
			}
		}
	}, false);

	for (var i = 0; i < english.length; i++) {
		done[i] = false;
	}

	game.load.atlasJSONHash('sheet', 'assets/sheet.png', 'assets/sheet.json');

	game.load.audio('fire', [ 'assets/audio/sfx_laser1.mp3', 'assets/audio/sfx_laser1.ogg', 'assets/audio/sfx_laser1.m4a' ]);
}

var player;
var bullets;
var buttons;

var fire;

var cursors;
var fireButton;

var scoreText;

var enemy = null;

var bullet;
var enemyBullets = [];
var enemyLetters = [];
var enemyBulletsGroup;
var enemyBulletTimes = [];

var phaserKeys = [
	Phaser.Keyboard.A,
	Phaser.Keyboard.B,
	Phaser.Keyboard.C,
	Phaser.Keyboard.D,
	Phaser.Keyboard.E,
	Phaser.Keyboard.F,
	Phaser.Keyboard.G,
	Phaser.Keyboard.H,
	Phaser.Keyboard.I,
	Phaser.Keyboard.J,
	Phaser.Keyboard.K,
	Phaser.Keyboard.L,
	Phaser.Keyboard.M,
	Phaser.Keyboard.N,
	Phaser.Keyboard.O,
	Phaser.Keyboard.P,
	Phaser.Keyboard.Q,
	Phaser.Keyboard.R,
	Phaser.Keyboard.S,
	Phaser.Keyboard.T,
	Phaser.Keyboard.U,
	Phaser.Keyboard.V,
	Phaser.Keyboard.W,
	Phaser.Keyboard.X,
	Phaser.Keyboard.Y,
	Phaser.Keyboard.Z
];

var keys = [
	'a',
	'b',
	'c',
	'd',
	'e',
	'f',
	'g',
	'h',
	'i',
	'j',
	'k',
	'l',
	'm',
	'n',
	'o',
	'p',
	'q',
	'r',
	's',
	't',
	'u',
	'v',
	'w',
	'x',
	'y',
	'z',
];

var words = [
	
];

var sprites = [

];

var time = 0;

function create() {
	game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
	game.scale.pageAlignVertically = true;
	game.scale.pageAlignHorizontally  = true;

	game.plugins.add(Phaser.Plugin.SaveCPU);

	var bg = game.add.sprite(0, 0, 'sheet', 'Backgrounds/purple.png');
	bg.scale.setTo(2.0, 3.0);

	bullets = game.add.physicsGroup();
	bullets.createMultiple(32,　'sheet', 'PNG/Lasers/laserBlue01.png', false);
	bullets.setAll('checkWorldBounds', true);
	bullets.setAll('outOfBoundsKill', true);

	enemyBulletsGroup = game.add.physicsGroup();
	enemyBulletsGroup.createMultiple(32,　'sheet', 'PNG/Lasers/laserGreen13.png', false);
	enemyBulletsGroup.setAll('checkWorldBounds', true);
	enemyBulletsGroup.setAll('outOfBoundsKill', true);

	player = game.add.sprite(game.scale.width / 2, 450, 'sheet', 'PNG/playerShip1_red.png');
	player.scale.setTo(0.5, 0.5);
	player.anchor.setTo(0.5);
	game.physics.arcade.enable(player);
	player.body.collideWorldBounds = true;

	fire = game.add.audio('fire');

	stars = game.add.group();
	stars.enableBody = true;
	wordsGroup = game.add.group();

	scoreText = game.add.text(16, 16, null, { fontSize: '32px', fill: '#ffffff' });

	buttons = game.add.group();
	buttons.enableBody = true;
	createKeys();
	time = game.time.time;

	for (var i = 0; i < keys.length; i++) {
		var key = game.input.keyboard.addKey(phaserKeys[i]);
		var character = keys[i];
		key.onDown.add(typed(character), this);
	}
}

function append(char) {
	scoreText.text = scoreText.text + char;
}

function createKeys() {
	var scaling = 0.45;
	var scalingY = 0.50;
	var initialOffsetX = 0;
	var initialOffsetY = 480;
	var offset = 30 + 5;

	var row = [ 'Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P' ];
	var row2 = [ 'A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L' ];
	var row3 = [ 'Z', 'X', 'C', 'V', 'B', 'N', 'M' ];

	for (var i = 0; i < row.length; i++) {
		var button = buttons.create(initialOffsetX + (offset * i), initialOffsetY, 'sheet', 'keyboard/letters/Keyboard_White_' + row[i] + '.png');
		button.scale.setTo(scaling, scalingY);
		button.inputEnabled = true;
		var character = row[i];
		button.events.onInputDown.add(typed(character.toLowerCase()), this);
	}
	
	for (var i = 0; i < row2.length; i++) {
		var button = buttons.create(initialOffsetX + 18 + (offset * i), initialOffsetY + 50, 'sheet', 'keyboard/letters/Keyboard_White_' + row2[i] + '.png');
		button.scale.setTo(scaling, scalingY);
		button.inputEnabled = true;
		var character = row2[i];
		button.events.onInputDown.add(typed(character.toLowerCase()), this);
	}
	
	for (var i = 0; i < row3.length; i++) {
		var button = buttons.create(initialOffsetX + 35 + (offset * i), initialOffsetY + 100, 'sheet', 'keyboard/letters/Keyboard_White_' + row3[i] + '.png');
		button.scale.setTo(scaling, scalingY);
		button.inputEnabled = true;
		var character = row3[i];
		button.events.onInputDown.add(typed(character.toLowerCase()), this);
	}

	var backspaceButton = buttons.create(initialOffsetX + 40 + (offset * 7), initialOffsetY + 100, 'sheet', 'keyboard/functions/Keyboard_White_Backspace_Alt.png');
	backspaceButton.scale.setTo(scaling, scalingY);
	backspaceButton.inputEnabled = true;
	backspaceButton.events.onInputDown.add(function() {
		if (scoreText.text.length > 0) {
			scoreText.text = scoreText.text.substring(0, scoreText.text.length - 1);
		}
	}, this);
}

function typed(character) {
	return () => {
		scoreText.text = scoreText.text + character;
		if (scoreText.text.trim().length === 1) {
			for (var i = 0; i < enemyLetters.length; i++) {
				if (enemyLetters[i] !== null && enemyLetters[i] !== undefined) {
					if (enemyLetters[i].text === character) {
						scoreText.text = "";
						bullet = bullets.getFirstExists(false);

						if (bullet) {
							fire.play();
							bullet.scale.setTo(0.5, 0.5);
							bullet.reset(player.x - 2, player.y - 12);
							bullet.body.velocity.x = -enemyBullets[i].body.velocity.x;
							bullet.body.velocity.y = -enemyBullets[i].body.velocity.y;
							bullet.target = enemyBullets[i];
						}
						break;
					}
				}
			}
		}

		for (var i = 0; i < words.length; i++) {
			if (english[i].toLowerCase() === scoreText.text.trim()) {
				fireBullet(sprites[i]);
				scoreText.text = "";
				break;
			}
		}
	}
}

function update () {
	for (var i = 0; i < sprites.length; i++) {
		if (sprites[i] !== null && sprites[i] !== undefined && !sprites[i].inWorld) {
			sprites[i].kill();
			words[i].kill();
			sprites[i] = null;
			words[i] = null;
			done[i] = false;
		}
	}

	for (var i = 0; i < enemyBullets.length; i++) {
		if (enemyBullets[i] !== null && enemyBullets[i] !== undefined && !enemyBullets[i].inWorld) {
			enemyBullets[i].kill();
			enemyLetters[i].kill();
			enemyBullets[i] = null;
			enemyLetters[i] = null;
		}
	}

	if (game.time.time - time > 2000) {
		time = game.time.time;

		for (var i = 0; i < done.length; i++) {
			if (!done[i]) {
				createEnemy();
				break;
			}
		}
	}

	for (var i = 0; i < enemyBulletTimes.length; i++) {
		if (enemyBulletTimes[i] !== null && enemyBulletTimes[i] !== undefined) {
			if (game.time.time > enemyBulletTimes[i] && sprites[i] != null) {
				enemyBulletTimes[i] = null;
				enemyBullets[i] = fireEnemyBullet(sprites[i], i);
			}
		}
	}

	for (var i = 0; i < words.length; i++) {
		if (words[i] !== null && words[i] !== undefined) {
			words[i].x = sprites[i].x;
			words[i].y = sprites[i].y - 25;
		}
	}

	for (var i = 0; i < enemyBullets.length; i++) {
		if (enemyBullets[i] !== null && enemyBullets[i] !== undefined) {
			enemyLetters[i].x = enemyBullets[i].x;
			enemyLetters[i].y = enemyBullets[i].y - 25;
		}
	}

	game.physics.arcade.overlap(bullets, sprites, destroy, null, this);
	game.physics.arcade.overlap(bullets, enemyBulletsGroup, destroy2, null, this);
}

function fireEnemyBullet(attackingEnemy, letterIndex) {
	var diff = ((attackingEnemy.body.x - player.body.x) / (attackingEnemy.body.y - player.body.y)) * 90;
	enemyBullet = enemyBulletsGroup.getFirstExists(false);

	if (enemyBullet) {
		fire.play();
		enemyBullet.scale.setTo(0.5, 0.5);
		enemyBullet.reset(attackingEnemy.x + 20, attackingEnemy.y + 30);
		enemyBullet.body.velocity.x = diff;
		enemyBullet.body.velocity.y = 100;

		var index = Math.floor(Math.random() * 26);
		var letter = game.add.text(0, 0, keys[index], { font: 'bold 16pt Arial', fill: "#88FF88" });
		letter.anchor.set(0.5);
		letter.setShadow(5, 5, 'rgba(0,0,0,0.5)', 5);
		enemyLetters[letterIndex] = letter;
	}
	return enemyBullet;
}

function createEnemy() {
	var index = Math.floor(Math.random() * japanese.length);
	while (done[index]) {
		index = Math.floor(Math.random() * japanese.length);
	}

	var x = Math.floor(Math.random() * (game.width - 50)) + 50;
	var enemy = stars.create(x, 0, 'sheet', 'PNG/Enemies/enemyBlack1.png');
	enemy.scale.setTo(0.5, 0.5);
	enemy.body.velocity.y = 50;

	words[index] = game.add.text(0, 0, japanese[index], { font: 'bold 16pt Arial', fill: "#88FF88" });
	words[index].anchor.set(0.5);
	words[index].setShadow(5, 5, 'rgba(0,0,0,0.5)', 5);
	wordsGroup.add(words[index]);

	sprites[index] = enemy;
	enemyBulletTimes[index] = Math.random() * 2000 + game.time.time;
	done[index] = true;
}

function destroy(word, bullet) {
	for (var i = 0; i < sprites.length; i++) {
		if (sprites[i] === word && bullet.target === sprites[i]) {
			sprites[i].destroy();
			words[i].destroy();
			enemyBulletTimes[i] = null;
			bullet.destroy();

			sprites[i] = null;
			words[i] = null;
			done[i] = false;
			break;
		}
	}
}

function destroy2(word, bullet) {
	for (var i = 0; i < enemyBullets.length; i++) {
		if (enemyBullets[i] === bullet && word.target === enemyBullets[i]) {
			enemyBullets[i].destroy();
			enemyLetters[i].destroy();
			enemyBullets[i] = null;
			enemyLetters[i] = null;
			word.destroy();
		}
	}
}

function fireBullet(enemy) {
	var diff = ((enemy.body.x - player.body.x) / (enemy.body.y - player.body.y)) * -450;
	bullet = bullets.getFirstExists(false);

	if (bullet) {
		fire.play();
		bullet.scale.setTo(0.5, 0.5);
		bullet.reset(player.x - 2, player.y - 12);
		bullet.body.velocity.x = diff;
		bullet.body.velocity.y = -450;
		bullet.target = enemy;
	}
}

function render () {

}

</script>
</body>
</html>
